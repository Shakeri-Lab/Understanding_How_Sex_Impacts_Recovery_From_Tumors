# `microenv.py` - Immune Microenvironment Analysis using xCell

## Overview

This script performs immune cell deconvolution using the xCell algorithm on RNA-seq data for a specific cohort of melanoma patients. It calculates enrichment scores for a focused panel of immune and stromal cell types deemed relevant to Immune Checkpoint Blockade (ICB) response. The primary goal is to integrate these immune scores with existing clinical data at the sample level.

To circumvent persistent issues with Python-R object conversion using `rpy2`, this script adopts a strategy where the core xCell analysis, score processing, and data merging steps are executed entirely within an embedded R script block called from Python.

## Workflow

The script executes the following major steps:

1.  **Load Python Inputs:**
    *   Loads the pre-filtered clinical data for melanoma patients with sequencing (`codes/output/melanoma_patients_with_sequencing.csv`, generated by `data_loading.py`).
    *   Loads the full RNA-seq expression matrix (TPM values expected) using the `load_rnaseq_data` function (imported from `data_loading.py`).
    *   Loads the Ensembl ID to HUGO Gene Symbol mapping file (`codes/output/ensembl_to_hugo.csv`, generated by `parse_hgnc_owl.py`).

2.  **Python Data Preparation:**
    *   Identifies the unique Sample IDs (SLIDs) corresponding to the melanoma patients present in the clinical data using the RNA-seq QC file (`Manifest_and_QC_Files/*_RNASeq_QCMetrics.csv`).
    *   Filters the columns of the expression matrix to keep only these relevant melanoma sample SLIDs.
    *   Filters the rows of the expression matrix to keep only genes with a mean TPM > 1 across the selected samples.
    *   Maps the gene identifiers (rows, assumed Ensembl IDs) in the filtered expression matrix to HUGO Gene Symbols using the loaded mapping file. Handles potential Ensembl version suffixes (e.g., `.14`). Averages expression values for duplicate HUGO symbols resulting from the mapping.
    *   Converts the final, processed pandas DataFrame (`expr_matrix_mapped`, with HUGO symbols as index and SLIDs as columns) into an R `data.frame` (`r_df`) using `rpy2`'s `localconverter` and `pandas2ri`. This conversion preserves the HUGO symbols as R rownames.
    *   Captures the list of sample SLIDs from the pandas DataFrame columns (`py_sample_ids`).

3.  **Execute Embedded R Script:**
    *   Passes the R data.frame (`r_df`), the Python list of SLIDs (`py_sample_ids`), the `FOCUSED_XCELL_PANEL` list, and necessary file paths into the R environment using `ro.r.assign`.
    *   Executes a multi-step R script using `ro.r()`:
        *   Loads R libraries `xCell` and `data.table`.
        *   Logs the `xCell` package version being used.
        *   Runs `xCellAnalysis` on the input `expr_data_df` **without** `cell.types.use` to get scores for all default cell types (necessary due to limitations in xCell v1.1.0).
        *   Includes debugging prints for the structure of the returned `scores_r` object.
        *   Subsets the full `scores_r` matrix rows to keep only those cell types present in the `focused_panel`.
        *   Processes the subsetted scores: transposes the matrix (`t()`), converts it to an R `data.table`, and adds the `input_sample_ids` as a new `SLID` column.
        *   Loads the RNA-Seq QC file using `fread` to create an SLID-to-PATIENT_ID mapping (`map_dt`). Handles different possible patient ID column names (`ORIENAvatarKey` or `PATIENT_ID`) in the QC file.
        *   Merges the `PATIENT_ID` onto the `scores_dt` using the `SLID` column (`merge`, `all.x=TRUE`).
        *   Loads the input clinical data file (`melanoma_patients_with_sequencing.csv`) using `fread`.
        *   Merges the clinical data onto the scores table using `PATIENT_ID` (`merge`, `all.x=TRUE`), taking only the first match for each patient in the clinical data (`unique(clinical_dt, by="PATIENT_ID")`) to avoid row duplication if the clinical file contains multiple rows per patient.
        *   Writes the final merged `data.table` (`final_dt`) to the specified output CSV file using `fwrite`.

4.  **Python Completion:** If the R script executes without error, the Python script logs completion.

## Inputs

The script requires the following files to be present:

1.  **Processed Clinical Data:**
    *   Path: `/project/orien/data/aws/24PRJ217UVA_IORIG/codes/output/melanoma_patients_with_sequencing.csv`
    *   Origin: Generated by `src/immune_analysis/data_loading.py`. Contains clinical information filtered for melanoma patients with available sequencing data.
2.  **RNA-Seq Expression Data:**
    *   Path: Loaded by `load_rnaseq_data` from `/project/orien/data/aws/24PRJ217UVA_IORIG/RNAseq/gene_and_transcript_expression_results/*.genes.results`
    *   Origin: Raw data files. Expected format is typically one file per sample, tab-separated, with gene IDs and TPM values.
3.  **Gene ID Mapping:**
    *   Path: `/project/orien/data/aws/24PRJ217UVA_IORIG/codes/output/ensembl_to_hugo.csv`
    *   Origin: Generated by `src/immune_analysis/parse_hgnc_owl.py`. Contains two columns: `Ensembl_ID` and `HGNC_Symbol`.
4.  **RNA-Seq QC Metrics:**
    *   Path: `/project/orien/data/aws/24PRJ217UVA_IORIG/Manifest_and_QC_Files/*_RNASeq_QCMetrics.csv` (The script uses `glob` to find the specific file, e.g., `24PRJ217UVA_20250130_RNASeq_QCMetrics.csv`).
    *   Origin: Provided QC data. Used *within the R script* to map SLIDs (from scores) back to PATIENT_IDs for merging. Must contain `SLID` and either `ORIENAvatarKey` or `PATIENT_ID` columns.

## Outputs

The primary output is a single CSV file:

*   **Merged Immune & Clinical Data:**
    *   Path: `/project/orien/data/aws/24PRJ217UVA_IORIG/codes/output/melanoma_analysis/melanoma_sample_immune_clinical.csv`
    *   Content: A table where each row represents an RNA-Seq sample (SLID). Columns include:
        *   `SLID`: The sample identifier.
        *   `PATIENT_ID`: The corresponding patient identifier.
        *   14 columns containing the calculated xCell enrichment scores for the `FOCUSED_XCELL_PANEL`.
        *   All columns from the input clinical data file (`melanoma_patients_with_sequencing.csv`), merged based on `PATIENT_ID`.

## Dependencies

*   **Python:**
    *   `pandas`
    *   `numpy`
    *   `rpy2` (ensure it's configured correctly with your R installation)
    *   Standard libraries (`os`, `glob`, `logging`, `datetime`, `traceback`, `multiprocessing`)
*   **R:** (Must be installed and accessible by `rpy2`)
    *   `xCell` package (Tested with v1.1.0 on R 4.3 - newer versions might behave differently). Install via BiocManager: `BiocManager::install("xCell")`.
    *   `data.table` package (Used for efficient merging/writing in R). Install via `install.packages("data.table")`.
    *   Base R functions.

## Configuration

*   **Base Path:** The script assumes a base path defined within the script: `BASE_PATH = "/project/orien/data/aws/24PRJ217UVA_IORIG"`. Input and output file paths are constructed relative to this.
*   **Focused Panel:** The list `FOCUSED_XCELL_PANEL` within the script defines the 14 cell types/scores to be included in the final output. This list was chosen based on relevance to melanoma ICB response.

## Usage

1.  **Prerequisites:** Ensure the following scripts have been run successfully and their outputs exist:
    *   `python -m src.immune_analysis.data_loading` (generates `melanoma_patients_with_sequencing.csv`)
    *   `python -m src.immune_analysis.parse_hgnc_owl` (generates `ensembl_to_hugo.csv`)
2.  **Environment:** Activate the correct Python environment where all dependencies (`pandas`, `numpy`, `rpy2`) are installed. Ensure this environment's `rpy2` is linked to an R installation containing the required R packages (`xCell`, `data.table`).
3.  **Run Script:** Execute the script from the project's root directory (e.g., `/project/orien/data/aws/24PRJ217UVA_IORIG/codes`):
    ```bash
    python -m src.immune_analysis.microenv
    ```
4.  **Check Output:** Verify the creation and content of `codes/output/melanoma_analysis/melanoma_sample_immune_clinical.csv`. Check the log output (`.log` file if logging is configured, or console output) for any warnings or errors, especially during the R execution block.

## Key Parameters & Choices

*   **`FOCUSED_XCELL_PANEL`**: This list dictates which 14 of the default xCell scores are kept in the final output. Modifying this list changes the scope of the output immune scores.
*   **Gene Filtering (Mean TPM > 1)**: This threshold removes low-expression genes before running xCell. Adjusting this threshold might impact the number of genes used and potentially the results.
*   **Duplicate Gene Handling (Averaging)**: When multiple Ensembl IDs map to the same HUGO symbol, their expression is averaged. The script notes that log-transform averaging could be considered for robustness.
*   **R Execution:** The core analysis is done via an embedded R script to ensure stability and avoid `rpy2` conversion issues encountered previously.

## Potential Issues & Troubleshooting

*   **`rpy2` Setup:** Ensure `rpy2` is correctly installed and configured to find your R installation. Environment variables (`R_HOME`) might need to be set.
*   **R Package Installation:** The required R packages (`xCell`, `data.table`) must be installed in the R environment that `rpy2` is using. See Dependencies section.
*   **xCell Version:** This script was developed and debugged against xCell v1.1.0. Newer versions (like xCell2) have different features and might require code changes (e.g., re-enabling `cell.types.use`, handling different output formats). The embedded R script logs the version being used.
*   **File Paths:** Double-check that the hardcoded paths for input files (QC, clinical, mapping) and the output directory match your project structure.
*   **QC File Columns:** The R script expects `SLID` and either `ORIENAvatarKey` or `PATIENT_ID` in the RNA-Seq QC file for mapping. If names differ, the R script block needs adjustment.
*   **Memory:** Running xCell can be memory-intensive, especially the initial calculation on all types. Ensure sufficient RAM is available.
