# Data Processing Module

This module contains scripts for processing and exploring raw clinical and molecular data files, with a focus on melanoma patients and their sequencing data.

## Files

- `eda.py`: Performs exploratory data analysis (EDA) on clinical and molecular data, focusing on melanoma patients with sequencing data.
- `postprocess.py`: Post-processes the output from eda.py for further melanoma-specific analysis or reporting.
- `utils.py`: Utility functions shared across scripts (e.g., data cleaning, ID mapping).

## Usage

The scripts can be run as modules with the following commands:

### Running EDA Script
```bash
python -m src.data_processing.eda --base-path /project/orien/data/aws/24PRJ217UVA_IORIG --output-dir codes/output
```

**Purpose**: Loads clinical and molecular data, filters for melanoma patients with sequencing data, aggregates clinical information, and generates summary statistics and plots.

**Arguments**:
- `--base-path`: Path to the project directory containing raw data files.
- `--output-dir`: Directory to save output files (e.g., processed data, plots).

**Output**: Saves processed data to `melanoma_patients_with_sequencing.csv` and generates plots (e.g., `sex_distribution.png`).

### Running Post-Processing Script
```bash
python -m src.data_processing.postprocess --input-file /project/orien/data/aws/24PRJ217UVA_IORIG/codes/output/melanoma_patients_with_sequencing.csv --output-dir output/data_analysis
```

**Purpose**: Takes the output from eda.py and performs additional analysis or generates detailed reports for melanoma patients.

**Arguments**:
- `--input-file`: Path to the `melanoma_patients_with_sequencing.csv` file generated by eda.py.
- `--output-dir`: Directory to save post-processed outputs.

**Output**: Generates further analysis files or reports in the specified output directory (e.g., histology reports, treatment analysis).

## Logic Behind the Processes

### EDA Script (eda.py)
The eda.py script is designed to explore and preprocess clinical and molecular data, focusing on melanoma patients with sequencing data. Its key steps include:

**Data Loading**:
- Loads clinical data files (e.g., PatientMaster.csv, Diagnosis.csv, Medications.csv, VitalStatus.csv).
- Loads molecular linkage data (ClinicalMolLinkage.csv) to connect patients to samples.

**Filtering**:
- Identifies patients with at least one melanoma diagnosis based on histology codes.
- Identifies patients with sequencing data explicitly linked to a *melanoma* histology/behavior code in the ClinicalMolLinkage file.
- Selects the final patient cohort based on the intersection of these two sets (must have both melanoma diagnosis AND melanoma-linked sequencing).

**Aggregation**:
- Aggregates diagnosis information *specifically from melanoma records*:
    - `MelanomaHistologyCodes`: List of unique melanoma histology codes for the patient.
    - `EarliestMelanomaDiagnosisAge`: The earliest age at which a melanoma diagnosis was recorded.
    - `MelanomaClinStages`/`MelanomaPathStages`: Lists of unique clinical/pathological stages recorded *only* for melanoma diagnoses, after cleaning/standardization.
- Aggregates treatment data, identifying ICB treatments and earliest start age.

**ICB Treatment Analysis**:
- Identifies ICB treatments and calculates `ICB_START_AGE` (earliest start age).
- Assigns `STAGE_AT_ICB` using a refined logic: Finds the *melanoma* diagnosis closest in time (but not after) ICB start, prioritizing Pathological stage over Clinical stage from that specific record.

**Outcome and Survival Analysis**:
- Aggregates outcome data (e.g., vital status, last contact date).
- Calculates `OS_STATUS` (0=Alive, 1=Dead) based on mapping `VitalStatus` (case-insensitive).
- Calculates `OS_TIME` (in months) from `EarliestMelanomaDiagnosisAge` to `AgeAtLastContact`.

**Sequencing Data Integration**:
- Extracts `MelanomaSequencingSamples` (WES/RNASeq IDs prefixed) and corresponding `SequencingAges` (Age At Specimen Collection) from the melanoma-linked entries in ClinicalMolLinkage.
- Calculates `EarliestSequencingAge` as the minimum valid age found in `SequencingAges` (derived from melanoma-linked samples in ClinicalMolLinkage).
- Determines `SequencingBeforeICB` by comparing each `SequencingAges` value to `ICB_START_AGE`.

**Output Generation**:
- Saves the processed patient-level data (one row per patient) to `melanoma_patients_with_sequencing.csv`, ensuring list-like columns are stored as strings.
- Generates summary statistics (e.g., `summary_statistics.csv`) and plots (e.g., sex distribution).


### Post-Processing Script (postprocess.py)
The postprocess.py script builds on the output of eda.py to provide deeper insights into melanoma patients. Its key steps include:

**Input Loading**:
- Loads the processed data from `melanoma_patients_with_sequencing.csv`.

**Further Analysis**:
- Performs melanoma-specific analysis, such as detailed histology reporting or treatment response evaluation.
- May filter data further or calculate additional metrics (e.g., treatment duration, stage transitions).

**Output Generation**:
- Saves results or reports (e.g., `melanoma_histology.csv`, `melanoma_treatment.csv`) to the specified output directory.


## Output Files

### EDA Script

- `melanoma_patients_with_sequencing.csv`: Processed patient-level data (one row per patient) with aggregated clinical and sequencing information. Key columns include:
    - `MelanomaClinStages`/`MelanomaPathStages`: Lists of unique stages derived *only* from melanoma diagnoses.
    - `STAGE_AT_ICB`: The inferred melanoma stage at ICB treatment start (Pathological preferred over Clinical).
    - `OS_STATUS`/`OS_TIME`: Survival status (0/1) and time (months) calculated from `EarliestMelanomaDiagnosisAge`.
    - `EarliestSequencingAge`: Earliest `Age At Specimen Collection` found among melanoma-linked samples in the linkage file.
    - `MelanomaSequencingSamples`/`SequencingAges`/`SequencingBeforeICB`: Details about melanoma-linked sequencing derived from the linkage file.
- `sex_distribution.png`: Plot showing the distribution of patients by sex.
- `summary_statistics.csv`: Summary statistics of the processed data (e.g., patient counts, stage distribution).
- `icb_distribution.csv`: Distribution of ICB treatments among patients.

### Post-Processing Script

Output files vary based on the specific analysis:
- `melanoma_histology.csv`: Detailed histology report for melanoma patients.
- `melanoma_treatment.csv`: ICB treatment details for melanoma patients.


## Dependencies

- pandas: Data manipulation and analysis.
- numpy: Numerical computations.
- matplotlib: Plotting and visualization.
- seaborn: Enhanced statistical visualizations.
- scipy: Scientific computations.
- lifelines: Survival analysis.

## Debugging Common Issues

- **Missing Data Files**: Ensure all required clinical and molecular data files are present in the `--base-path` directory.
- **Column Name Mismatches**: Verify that column names in input files match those expected by the scripts (e.g., PATIENT_ID, Histology).
- **ID Mapping Issues**: Check the ClinicalMolLinkage.csv file for correct patient and sample ID mappings.
- **Plot Generation Failures**: Ensure matplotlib and seaborn are installed and that the output directory is writable.

## Package Structure
```
src/
├── __init__.py
├── data_processing/
│   ├── __init__.py
│   ├── eda.py                       # Exploratory data analysis
│   ├── postprocess.py               # Melanoma-specific post-processing
│   ├── utils.py                     # Shared utility functions
│   └── README.md                    # Documentation
``` 